name: Register Homelab Secrets

on:
  workflow_dispatch: {}

jobs:
  register-secrets:
    name: Register Homelab secrets (manual)
    runs-on: [self-hosted, homelab]
    if: github.event_name == 'workflow_dispatch' && secrets.SECRETS_AGENT_API_KEY != ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure script is executable
        run: chmod +x ./scripts/secrets-agent/register-homelab-secrets.sh

      - name: Register secrets into Secrets Agent
        env:
          SECRETS_AGENT_URL: ${{ secrets.SECRETS_AGENT_URL }}
          SECRETS_AGENT_API_KEY: ${{ secrets.SECRETS_AGENT_API_KEY }}
        run: |
          echo "Registering homelab secrets via Secrets Agent at $SECRETS_AGENT_URL"
          ./scripts/secrets-agent/register-homelab-secrets.sh

      - name: Verify secrets present (light check)
        env:
          SECRETS_AGENT_URL: ${{ secrets.SECRETS_AGENT_URL }}
          SECRETS_AGENT_API_KEY: ${{ secrets.SECRETS_AGENT_API_KEY }}
        run: |
          curl -sf -H "X-API-KEY: $SECRETS_AGENT_API_KEY" "$SECRETS_AGENT_URL/secrets" | jq '. | map(select(.name=="local/homelab"))'
